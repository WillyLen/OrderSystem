@{
    ViewBag.Title = "選擇第二因子驗證";
    var sessionId = (string)ViewBag.SessionId;
    bool totpEnabled = ViewBag.TotpEnabled == true;
    string otpAuthUri = ViewBag.OtpAuthUri as string;  // 未啟用時才有
    string manualKey = ViewBag.ManualKey as string;
}

<h2>選擇第二因子驗證</h2>

@if (TempData["MfaError"] != null)
{
    <div class="alert alert-danger">@TempData["MfaError"]</div>
}
@if (TempData["MfaInfo"] != null)
{
    <div class="alert alert-info">@TempData["MfaInfo"]</div>
}

<div class="row" style="gap:24px">
    <div class="col" style="min-width:320px;border:1px solid #ddd;border-radius:12px;padding:16px">
        <h3>① 一次性 OTP</h3>
        <p>每次登入發一組 60 秒效期的驗證碼。</p>
        <a class="btn btn-primary" href="@Url.Action("ShowOtp","Auth", new { sessionId = sessionId })">使用一次性 OTP</a>
    </div>

    <div class="col" style="min-width:320px;border:1px solid #ddd;border-radius:12px;padding:16px">
        <h3>② Authenticator (TOTP)</h3>

        @if (!totpEnabled)
        {
            <p>尚未啟用。請用 Google/Microsoft Authenticator 掃描下方 QR，或手動輸入金鑰。</p>
            if (ViewBag.QrDataUrl != null)
            {
                <div style="margin:12px 0">
                    <img src="@ViewBag.QrDataUrl" alt="Authenticator QR" width="220" height="220" />
                </div>
            }


            <div>
                <p><strong>金鑰：</strong> <code>@manualKey</code></p>
            </div>

            <form action="@Url.Action("EnableTotp", "Auth")" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="sessionId" value="@((string)ViewBag.SessionId)" />
                <label>掃描後輸入 App 顯示的 6 碼以完成啟用：</label>
                <input type="text" name="code" maxlength="6" autocomplete="one-time-code" />
                <button type="submit" class="btn btn-success">確認啟用</button>
            </form>

        }
        else
        {
            <p>已啟用，請輸入 Authenticator App 顯示的 6 碼完成登入。</p>

            <form action="@Url.Action("VerifyTotp","Auth")" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="sessionId" value="@((string)ViewBag.SessionId)" />
                <input type="text" name="code" maxlength="6" autofocus autocomplete="one-time-code" />
                <button type="submit" class="btn btn-success">驗證登入</button>
            </form>

        }
    </div>
</div>
